import*as e from"three";import{PointerLockControls as t}from"three/addons/controls/PointerLockControls.js";import{GLTFLoader as o}from"three/addons/loaders/GLTFLoader.js";import{initializeFastTravelMenu as a}from"./fastTravel.js";import{initializeTouchLook as r}from"./touchLook.js";let canvas=document.querySelector("#three-canvas"),renderer=new e.WebGLRenderer({canvas,antialias:!0});renderer.setSize(window.innerWidth,window.innerHeight),renderer.setPixelRatio(window.devicePixelRatio>1?2:1);let scene=new e.Scene;scene.background=new e.Color("white");let camera=new e.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3);camera.position.set(-7,20,124),scene.add(camera),a(camera);let updateCameraRotation=r(camera,renderer),ambientLight=new e.AmbientLight("white",.01);scene.add(ambientLight),renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));let menu=document.getElementById("fast-travel-menu");menu.style.display="block",menu.style.visibility="visible";let controls=new t(camera,renderer.domElement);controls.addEventListener("unlock",()=>console.log("Pointer unlocked")),document.addEventListener("click",e=>{let t=excludedElements.some(t=>e.target.closest(t));if(t){console.log("Interactive element clicked. Pointer lock prevented.");return}controls.isLocked||(controls.lock(),console.log("Pointer locked."))}),document.addEventListener("click",e=>{let t=["#menu-btn","#side-menu","#fast-travel-menu","#fast-travel-select","#fast-travel-button","#control-container"],o=t.some(t=>e.target.closest(t));if(o){console.log("Pointer lock prevented on excluded element.");return}controls.isLocked||(controls.lock(),console.log("Pointer locked for scene."))});let sideMenu=document.getElementById("side-menu"),menuBtn=document.getElementById("menu-btn"),closeBtn=document.getElementById("close-btn");menuBtn.addEventListener("click",()=>{sideMenu.style.width="250px",menuBtn.style.display="none",closeBtn.style.display="block",controls.unlock(),console.log("Pointer lock disabled for side menu")}),closeBtn.addEventListener("click",()=>{sideMenu.style.width="0",menuBtn.style.display="block",closeBtn.style.display="none",console.log("Pointer lock can be re-enabled")});let velocity=new e.Vector3,direction=new e.Vector3,move={forward:!1,backward:!1,left:!1,right:!1};function animateModels(e){if(!controls.isLocked)return;let t=calculateMovement(e,50);velocity.lerp(t,20*e);let o=camera.position.clone().add(velocity.clone().multiplyScalar(e));isOnWalkableArea(o)?camera.position.copy(o):(console.log("Blocked! Stay within walkable path."),velocity.set(0,0,0)),velocity.multiplyScalar(.85)}function calculateMovement(t,o){let a=new e.Vector3;camera.getWorldDirection(a),a.y=0,a.normalize();let r=new e.Vector3;r.crossVectors(a,camera.up).normalize(),new e.Vector3;let i=new e.Vector3;return move.forward&&i.add(a.multiplyScalar(o)),move.backward&&i.add(a.multiplyScalar(-o)),move.left&&i.add(r.multiplyScalar(-o)),move.right&&i.add(r.multiplyScalar(o)),i}document.addEventListener("keydown",e=>{switch(e.code){case"KeyW":move.forward=!0;break;case"KeyS":move.backward=!0;break;case"KeyA":move.left=!0;break;case"KeyD":move.right=!0}}),document.addEventListener("keyup",e=>{switch(e.code){case"KeyW":move.forward=!1;break;case"KeyS":move.backward=!1;break;case"KeyA":move.left=!1;break;case"KeyD":move.right=!1}});let gltfLoader=new o,animationMixers=[];function loadAnimatedCharacter(t,o,a,r={x:0,y:0,z:0}){gltfLoader.load(t,i=>{let n=i.scene;n.position.set(o.x,o.y,o.z),n.scale.set(a,a,a),n.rotation.set(r.x,r.y,r.z),scene.add(n);let l=new e.AnimationMixer(n);animationMixers.push(l),i.animations.forEach(e=>{l.clipAction(e).play()}),console.log(`Character loaded: ${t}`)},void 0,e=>console.error(`Error loading ${t}:`,e))}loadAnimatedCharacter("./man.glb",{x:30,y:1,z:21},5.5,{x:0,y:-(Math.PI/1.5),z:0}),gltfLoader.load("./vr_gallery.glb",e=>{let t=e.scene;t.scale.set(8,8,8),t.position.set(0,.5,0),scene.add(t),console.log("Shop scene loaded.")}),gltfLoader.load("./cow.glb",e=>{let t=e.scene;t.scale.set(1,1,1),t.position.set(0,2,0),scene.add(t),console.log("cow scene loaded.")});import{createSky as i}from"./sky.js";i(scene);let floorMesh=new e.Mesh(new e.PlaneGeometry(300,300),new e.MeshLambertMaterial({color:"burlywood"}));floorMesh.rotation.x=-Math.PI/2,scene.add(floorMesh);let walkableMaterial=new e.MeshBasicMaterial({color:65280,visible:!1}),walkableArea1=new e.Mesh(new e.PlaneGeometry(167,120),walkableMaterial);walkableArea1.rotation.x=-Math.PI/2,walkableArea1.position.set(0,1,65),scene.add(walkableArea1);let walkableArea2=new e.Mesh(new e.PlaneGeometry(60,125),walkableMaterial);walkableArea2.rotation.x=-Math.PI/2,walkableArea2.position.set(47,1,-20),scene.add(walkableArea2);let walkableArea3=new e.Mesh(new e.PlaneGeometry(70,125),walkableMaterial);walkableArea3.rotation.x=-Math.PI/2,walkableArea3.position.set(-47,1,-20),scene.add(walkableArea3);let walkableArea4=new e.Mesh(new e.PlaneGeometry(167,60),walkableMaterial);walkableArea4.rotation.x=-Math.PI/2,walkableArea4.position.set(0,1,-50),scene.add(walkableArea4);let walkableAreas=[walkableArea1,walkableArea2,walkableArea3,walkableArea4],groundRaycaster=new e.Raycaster,rayDirection=new e.Vector3(0,-1,0);function isOnWalkableArea(t){groundRaycaster.set(new e.Vector3(t.x,t.y+10,t.z),rayDirection);let o=groundRaycaster.intersectObjects(walkableAreas);return o.length>0}let textureLoader=new e.TextureLoader,photoMeshes=[],mediaItems=[{type:"image",path:"./bd1.png",size:{width:16,height:24},position:{x:-50,y:29,z:-85},rotation:{x:0,y:Math.PI/.1,z:0},url:"https://www.sothebys.com/en/buy/auction/2024/modern-contemporary-south-asian-art/untitled-couple"},{type:"image",path:"./bd2.png",size:{width:30,height:20},position:{x:-84,y:29,z:-52},rotation:{x:0,y:Math.PI/2,z:0},url:"https://artsandculture.google.com/asset/suite-olympic-centennial-solidarity/fAEPVfN6waT0mw?hl=en"},{type:"image",path:"./jp4.1.png",size:{width:25,height:10},position:{x:-84,y:35,z:-10},rotation:{x:0,y:Math.PI/2,z:0},url:"https://artsandculture.google.com/asset/suite-olympic-centennial-solidarity/fAEPVfN6waT0mw?hl=en"},{type:"image",path:"./jp4.2.png",size:{width:25,height:10},position:{x:-84,y:22,z:-10},rotation:{x:0,y:Math.PI/2,z:0},url:"https://artsandculture.google.com/asset/suite-olympic-centennial-solidarity/fAEPVfN6waT0mw?hl=en"},{type:"image",path:"./jp3.png",size:{width:30,height:20},position:{x:-84,y:29,z:30},rotation:{x:0,y:Math.PI/2,z:0},url:"https://mcraftsmanship.com/blogs/samue/the-great-wave-off-kanagawa-kanagawa-oki-nami-ura-katsushika-hokusai"},{type:"image",path:"./jp2.png",size:{width:30,height:20},position:{x:-84,y:29,z:68},rotation:{x:0,y:Math.PI/2,z:0},url:"http://goinjapanesque.com/01849/"},{type:"image",path:"./jp1.png",size:{width:30,height:20},position:{x:-84,y:29,z:107},rotation:{x:0,y:Math.PI/2,z:0},url:"http://goinjapanesque.com/01849/"},{type:"image",path:"./M1.png",size:{width:30,height:20},position:{x:85,y:29,z:104},rotation:{x:0,y:-Math.PI/2,z:0},url:"http://goinjapanesque.com/01849/"},{type:"image",path:"./M2.png",size:{width:30,height:20},position:{x:84,y:29,z:63},rotation:{x:0,y:-Math.PI/2,z:0},url:"http://goinjapanesque.com/01849/"},{type:"image",path:"./M3.png",size:{width:30,height:20},position:{x:84,y:29,z:20},rotation:{x:0,y:-Math.PI/2,z:0},url:"http://goinjapanesque.com/01849/"},{type:"image",path:"./M4.png",size:{width:30,height:20},position:{x:84,y:29,z:-20},rotation:{x:0,y:-Math.PI/2,z:0},url:"http://goinjapanesque.com/01849/"},{type:"image",path:"./VN2.png",size:{width:30,height:20},position:{x:84,y:29,z:-60},rotation:{x:0,y:-Math.PI/2,z:0},url:"http://goinjapanesque.com/01849/"},{type:"image",path:"./VN1.png",size:{width:16,height:24},position:{x:52,y:29,z:-85},rotation:{x:0,y:Math.PI/.1,z:0},url:"https://www.sothebys.com/en/buy/auction/2024/modern-contemporary-south-asian-art/untitled-couple"},{type:"video",path:"./bd2.mp4",size:{width:13,height:7},position:{x:-82,y:12,z:-52},rotation:{x:-(Math.PI/.48),y:Math.PI/2,z:0}},{type:"image",path:"./images/3.png",size:{width:9,height:5},position:{x:-25.2,y:27.5,z:-85},rotation:{x:0,y:0,z:Math.PI/.1},url:"http://www.example.com/photo3"},{type:"video",path:"./bd1.mp4",size:{width:13,height:7},position:{x:-51,y:12,z:-82},rotation:{x:-(Math.PI/8),y:0,z:0}},{type:"video",path:"./cowvid.mp4",size:{width:12,height:6.8},position:{x:20,y:15,z:5},rotation:{x:-(Math.PI/3.4),y:0,z:0},url:"https://www.canva.com/design/DAGX-XTM0jY/neLikvhpi3Sdj-L6AGIrWw/watch?utm_content=DAGX-XTM0jY&utm_campaign=share_your_design&utm_medium=link&utm_source=shareyourdesignpanel"}];mediaItems.forEach(t=>{let o;if("image"===t.type){let a=textureLoader.load(t.path);o=new e.ShaderMaterial({uniforms:{uTexture:{value:a},uBorderColor:{value:new e.Color(0)},uBorderWidth:{value:.01}},vertexShader:`
        varying vec2 vUv;
        void main() {
          vUv = uv;
          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
        }
      `,fragmentShader:`
        uniform sampler2D uTexture;
        uniform vec3 uBorderColor;
        uniform float uBorderWidth;
        varying vec2 vUv;
        void main() {
          float border = uBorderWidth;
          if (vUv.x < border || vUv.x > 1.0 - border || vUv.y < border || vUv.y > 1.0 - border) {
            gl_FragColor = vec4(uBorderColor, 1.0); // Border color
          } else {
            gl_FragColor = texture2D(uTexture, vUv);
          }
        }
      `})}else if("video"===t.type){let r=document.createElement("video");r.src=t.path,r.loop=!0,r.muted=!0,r.playsInline=!0,r.crossOrigin="anonymous",r.play();let i=new e.VideoTexture(r);o=new e.ShaderMaterial({uniforms:{uTexture:{value:i},uBorderColor:{value:new e.Color(0)},uBorderWidth:{value:.01}},vertexShader:`
        varying vec2 vUv;
        void main() {
          vUv = uv;
          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
        }
      `,fragmentShader:`
        uniform sampler2D uTexture;
        uniform vec3 uBorderColor;
        uniform float uBorderWidth;
        varying vec2 vUv;
        void main() {
          float border = uBorderWidth;
          if (vUv.x < border || vUv.x > 1.0 - border || vUv.y < border || vUv.y > 1.0 - border) {
            gl_FragColor = vec4(uBorderColor, 1.0); // Border color
          } else {
            gl_FragColor = texture2D(uTexture, vUv);
          }
        }
      `})}let n=new e.PlaneGeometry(t.size.width,t.size.height),l=new e.Mesh(n,o);if(l.position.set(t.position.x,t.position.y,t.position.z),t.rotation){let s=new e.Euler(t.rotation.x,t.rotation.y,t.rotation.z,"YXZ");l.quaternion.setFromEuler(s)}scene.add(l),l.userData={url:t.url},photoMeshes.push(l)});let photoRaycaster=new e.Raycaster,mouse=new e.Vector2;function isMobileDevice(){let e=navigator.userAgent||navigator.vendor||window.opera;return/Android|iPhone|iPad|iPod/i.test(e)}window.addEventListener("click",e=>{mouse.x=e.clientX/window.innerWidth*2-1,mouse.y=-(2*(e.clientY/window.innerHeight))+1,photoRaycaster.setFromCamera(mouse,camera);let t=photoRaycaster.intersectObjects(photoMeshes);if(t.length>0){let o=t[0].object;o.userData.url&&window.open(o.userData.url,"_blank")}}),isMobileDevice()?console.log("PointerLockControls disabled for mobile devices."):(controls.addEventListener("lock",()=>{console.log("Pointer locked.")}),controls.addEventListener("unlock",()=>{console.log("Pointer unlocked.")}),document.addEventListener("click",()=>{controls.lock()})),isMobileDevice()&&document.addEventListener("click",e=>{e.preventDefault(),console.log("Pointer lock prevented on mobile.")});let clock=new e.Clock;function draw(){let e=clock.getDelta();animationMixers.forEach(t=>{t.update(e)}),"function"==typeof updateCameraRotation&&updateCameraRotation(),animateModels(e),renderer.render(scene,camera),renderer.setAnimationLoop(draw)}function hideInstructions(){let e=document.getElementById("instructions");e&&(e.style.opacity="0",setTimeout(()=>{e.style.display="none"},500))}draw(),window.addEventListener("resize",()=>{camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight)}),document.addEventListener("DOMContentLoaded",()=>{let e=document.getElementById("instructions");if(e){let t=document.createElement("button");t.innerHTML="\xd7",t.style.cssText=`
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      color: white;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
    `,e.appendChild(t),t.addEventListener("click",hideInstructions),setTimeout(hideInstructions,6e4)}}),renderer.setPixelRatio(window.devicePixelRatio>1?1.5:1),draw();
